<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="attachedFile">
	<cacheModel id="user-cache" type="LRU" readOnly="true"
		serialize="false">
		<flushInterval hours="24" />
		<property value="500" name="size" />
	</cacheModel>
	
	
	<typeAlias alias="attached" type="com.ulewo.entity.AttachedFile" />
	<typeAlias alias="article" type="com.ulewo.entity.Article" />
	<!-- 创建附件 -->
	<insert id="addAttached" parameterClass="attached">
		insert into attached_file(articleid,gid,filename,fileurl,filetype,mark)
		values(#articleId#,#gid#,#fileName#,#fileUrl#,#fileType#,#mark#)
	</insert>
	
	<!-- 通过articleId查询附件 -->
	
	<select id="queryAttachedbyArticleId" resultClass="attached" parameterClass="java.util.Map">
		select id,articleid,gid,filename,mark,dcount from  attached_file where articleid = #articleId# and filetype = #fileType#
	</select>
	
	<select id="queryAttachedbyId" resultClass="attached" parameterClass="java.lang.Integer">
		select * from  attached_file where id = #id#
	</select>
	
	<!--删除附件-->
	<delete id="deleteAttached" parameterClass="java.util.Map">
		delete from  attached_file where articleid = #articleId# and filetype = #fileType#
	</delete>
	
	<update id="updateAttached" parameterClass="attached">
		update attached_file
		set id=#id#
		<isNotEmpty prepend="," property="fileName">
			filename=#fileName# 
    	</isNotEmpty>
    	<isNotEmpty prepend="," property="fileUrl">
			fileurl=#fileUrl# 
    	</isNotEmpty>
    	<isNotEmpty prepend="," property="mark">
			mark=#mark# 
    	</isNotEmpty>
    	<isNotEmpty prepend="," property="dcount">
			dcount=#dcount# 
    	</isNotEmpty>
		where id=#id#
	</update>
	
	<!-- 查询附件 -->
	<select id="attachedArticle" parameterClass="java.util.Map" resultClass="article">
		select a.title,a.id,a.posttime from attached_file f inner join article a on a.id=f.articleid where f.gid = #gid#
		order by a.posttime desc limit #offset#,#total#
	</select>
	
	<select id="attachedArticleCount" parameterClass="java.lang.String" resultClass="java.lang.Integer">
		select count(a.title) from attached_file f inner join article a on a.id=f.articleid where f.gid = #gid#
	</select>
</sqlMap>
